# PRP-003: PostgreSQL Database Foundation

## Description
Migrate from JSON/Redis to PostgreSQL for persistent storage of users, messages, facts, stats, and linear text history.

## Requirements
- Setup PostgreSQL database connection
- Create SQLAlchemy models for users, messages, facts, stats
- Implement linear text history storage (all messages in order)
- Database migrations with Alembic
- Connection pooling for performance
- Store user stats, info, facts
- Remove Redis dependency

## Definition of Ready (DOR)
- [ ] PostgreSQL instance available (local or cloud)
- [ ] DATABASE_URL configured in .env
- [ ] SQLAlchemy and Alembic dependencies added
- [ ] Current data storage patterns reviewed

## Definition of Done (DOD)
- [ ] PostgreSQL database setup and connected
- [ ] SQLAlchemy models created (User, Message, Fact, Stat)
- [ ] Alembic migrations initialized and working
- [ ] Linear message history storage implemented
- [ ] Connection pooling configured
- [ ] Redis dependency removed from requirements.txt
- [ ] Unit tests for database models
- [ ] Unit tests for database operations (CRUD)
- [ ] E2E test for message storage and retrieval

## Progress
- [ ] Add SQLAlchemy and Alembic to requirements.txt
- [ ] Create database.py with connection setup
- [ ] Create models/user.py (User model)
- [ ] Create models/message.py (Message model)
- [ ] Create models/fact.py (Fact model)
- [ ] Create models/stat.py (Stat model)
- [ ] Initialize Alembic migrations
- [ ] Create initial migration for all models
- [ ] Implement connection pooling
- [ ] Remove Redis references from codebase
- [ ] Write unit tests for User model
- [ ] Write unit tests for Message model
- [ ] Write unit tests for Fact model
- [ ] Write unit tests for Stat model
- [ ] Write E2E test for message storage flow

## Notes
- Schema design:
  - User: id, telegram_id, username, first_name, last_name, is_friend, created_at
  - Message: id, user_id, chat_id, text, timestamp, message_type
  - Fact: id, user_id, fact_text, created_at
  - Stat: id, user_id, stat_type, value, timestamp
- Linear history: store all messages with timestamp for RAG
- Use async SQLAlchemy for aiogram compatibility

## Agent Comments
<!-- Add progress notes here as you work on this PRP -->
