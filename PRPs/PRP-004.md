# PRP-004: Memories System

## Description
Implement memories system: prompts with matching expressions that can be added, edited, deleted only by admins (Vasilisa, Daniil) via DM or chat messages.

## Requirements
- Memory storage in PostgreSQL (prompts with matching expressions)
- Admin-only CRUD operations for memories via Telegram
- Memory matching engine to trigger actions
- Support for complex memory patterns (e.g., "send message fuu if any sasha mention you")
- Commands: /add_memory, /edit_memory, /delete_memory, /list_memories
- Ban functionality for memories

## Definition of Ready (DOR)
- [x] PostgreSQL database setup (from PRP-003)
- [ ] Memory model designed
- [ ] Admin detection working (from PRP-002)
- [ ] Memory matching logic planned

## Definition of Done (DOD)
- [ ] Memory model created in models/memory.py
- [ ] Memory service created in services/memory_service.py
- [ ] Admin handler for memory commands in handlers/admin.py
- [ ] Memory matching engine implemented
- [ ] /add_memory command working
- [ ] /edit_memory command working
- [ ] /delete_memory command working
- [ ] /list_memories command working
- [ ] Unit tests for memory CRUD operations
- [ ] Unit tests for memory matching engine
- [ ] E2E test for memory management flow

## Progress
- [ ] Design Memory model (id, admin_id, prompt, matching_expression, action, is_banned, created_at)
- [ ] Create models/memory.py
- [ ] Create services/memory_service.py with CRUD methods
- [ ] Create handlers/admin.py for admin commands
- [ ] Implement /add_memory command
- [ ] Implement /edit_memory command
- [ ] Implement /delete_memory command
- [ ] Implement /list_memories command
- [ ] Implement memory matching engine in services/memory_service.py
- [ ] Integrate memory matching in message handler
- [ ] Write unit tests for Memory model
- [ ] Write unit tests for memory CRUD
- [ ] Write unit tests for memory matching
- [ ] Write E2E test for adding and triggering memory

## Notes
- Memory structure:
  - prompt: instructions for bot behavior
  - matching_expression: regex or text pattern to match
  - action: what bot should do when matched
- Example: "send message fuu if any sasha mention you from any sasha"
  - matching_expression: "sasha"
  - action: "send_message: fuu"
- Admin-only: check user_id against ADMIN_VASILISA_ID and ADMIN_DANIIL_ID
- Ban functionality: set is_banned=True to disable memory without deleting

## Agent Comments
<!-- Add progress notes here as you work on this PRP -->
