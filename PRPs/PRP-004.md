# PRP-004: Memories System

## Description
Implement memories system: prompts with matching expressions that can be added, edited, deleted only by admins via DM or chat messages.

## Requirements
- Memory storage in PostgreSQL (prompts with matching expressions)
- Admin-only CRUD operations for memories via Telegram
- Memory matching engine to trigger actions
- Support for complex memory patterns (e.g., "send message fuu if any sasha mention you")
- Commands: /add_memory, /edit_memory, /delete_memory, /list_memories
- Ban functionality for memories
- **Import Telegram chat export as first memory/knowledge base**
- Process JSON export from old dcmaidbot conversations
- Extract personality, role understanding, and relationship context

## Definition of Ready (DOR)
- [x] PostgreSQL database setup (from PRP-003)
- [ ] Memory model designed
- [ ] Admin detection working (from PRP-002)
- [ ] Memory matching logic planned

## Definition of Done (DOD)
- [ ] Memory model created in models/memory.py
- [ ] Memory service created in services/memory_service.py
- [ ] Admin handler for memory commands in handlers/admin.py
- [ ] Memory matching engine implemented
- [ ] /add_memory command working
- [ ] /edit_memory command working
- [ ] /delete_memory command working
- [ ] /list_memories command working
- [ ] **Telegram chat export importer created (scripts/import_telegram_history.py)**
- [ ] **First memory loaded from old dcmaidbot chat history**
- [ ] **Bot understands her role and admin relationships from imported chat**
- [ ] Unit tests for memory CRUD operations
- [ ] Unit tests for memory matching engine
- [ ] Unit tests for Telegram import
- [ ] E2E test for memory management flow

## Progress
- [ ] Design Memory model (id, admin_id, prompt, matching_expression, action, is_banned, created_at)
- [ ] Create models/memory.py
- [ ] Create services/memory_service.py with CRUD methods
- [ ] Create handlers/admin.py for admin commands
- [ ] Implement /add_memory command
- [ ] Implement /edit_memory command
- [ ] Implement /delete_memory command
- [ ] Implement /list_memories command
- [ ] Implement memory matching engine in services/memory_service.py
- [ ] Integrate memory matching in message handler
- [ ] **Create scripts/import_telegram_history.py**
- [ ] **Export Telegram chat history with old dcmaidbot (see steps below)**
- [ ] **Import chat history as first memory/knowledge**
- [ ] **Validate bot personality and relationships from imported data**
- [ ] Write unit tests for Memory model
- [ ] Write unit tests for memory CRUD
- [ ] Write unit tests for memory matching
- [ ] Write unit tests for Telegram import
- [ ] Write E2E test for adding and triggering memory

## Notes
- Memory structure:
  - prompt: instructions for bot behavior
  - matching_expression: regex or text pattern to match
  - action: what bot should do when matched
- Example: "send message fuu if any sasha mention you from any sasha"
  - matching_expression: "sasha"
  - action: "send_message: fuu"
- Admin-only: check user_id against ADMIN_IDS and 
- Ban functionality: set is_banned=True to disable memory without deleting

## How to Export Telegram Chat History

### Step 1: Export from Telegram Desktop
1. Open Telegram Desktop
2. Open chat with old dcmaidbot
3. Click ⋮ (three dots menu) → Export chat history
4. Select format: **JSON**
5. Include:
   - ✅ Messages
   - ✅ Photos (optional)
   - ✅ Files (optional)
6. Date range: All time
7. Export to: `telegram_exports/old_dcmaidbot_chat.json`

### Step 2: Place Export in Repo
```bash
mkdir -p telegram_exports
# Copy exported JSON to telegram_exports/old_dcmaidbot_chat.json
```

### Step 3: Run Import Script
```bash
python scripts/import_telegram_history.py telegram_exports/old_dcmaidbot_chat.json
```

### What Gets Imported
The script will extract and create memories from:
1. **Role Understanding**: Bot's purpose, personality traits
2. **Relationship Context**: Admin relationships and context
3. **Personality Examples**: Kawai expressions, joke patterns, responses
4. **Previous Conversations**: Context of what was discussed before
5. **User Preferences**: Admin preferences, behavioral patterns

### Import Script Structure
```python
# scripts/import_telegram_history.py
def import_telegram_json(json_file_path):
    # Parse Telegram JSON export
    # Extract messages with bot personality insights
    # Create memory entries for:
    #   - Admin relationships (from context)
    #   - Bot's role and personality
    #   - Common interactions and patterns
    # Store in database as first memories
```

## Agent Comments
<!-- Add progress notes here as you work on this PRP -->
