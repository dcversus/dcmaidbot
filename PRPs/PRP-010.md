# PRP-010: Testing Framework & E2E Tests

## Description
Establish comprehensive testing infrastructure with unit tests for all features and E2E tests for complete bot interaction flows.

## Requirements
- Unit test infrastructure for all modules
- E2E test suite for bot interactions
- Mock Telegram API for testing
- Test fixtures and factories
- CI/CD integration for automated testing
- Code coverage reporting
- Test all PRPs (001-009) features

## Definition of Ready (DOR)
- [x] All PRPs (001-009) implemented
- [ ] pytest and pytest-asyncio installed
- [ ] Test directory structure planned
- [ ] Mock framework selected (pytest-mock or unittest.mock)

## Definition of Done (DOD)
- [ ] Unit tests for all services (memory, joke, rag, cron, tool)
- [ ] Unit tests for all models (user, message, fact, stat, memory, joke, cron_task)
- [ ] Unit tests for all handlers (waifu, admin, favors, jokes)
- [ ] E2E test for admin flow (add memory, trigger memory)
- [ ] E2E test for friend favor flow (request web search)
- [ ] E2E test for joke flow (generate joke, track reaction)
- [ ] E2E test for RAG flow (context-aware response)
- [ ] Mock Telegram API created
- [ ] CI/CD workflow with tests (.github/workflows/test.yml)
- [ ] Code coverage >80%
- [ ] All tests passing

## Progress
- [ ] Setup test directory structure (tests/unit/, tests/e2e/)
- [ ] Create conftest.py with fixtures
- [ ] Create mock Telegram API in tests/mocks/telegram.py
- [ ] Write unit tests for services/memory_service.py
- [ ] Write unit tests for services/joke_service.py
- [ ] Write unit tests for services/rag_service.py
- [ ] Write unit tests for services/cron_service.py
- [ ] Write unit tests for services/tool_service.py
- [ ] Write unit tests for all models
- [ ] Write unit tests for all handlers
- [ ] Write E2E test for admin memory management
- [ ] Write E2E test for friend favor request
- [ ] Write E2E test for joke generation and learning
- [ ] Write E2E test for RAG-powered response
- [ ] Create GitHub Actions test workflow
- [ ] Setup code coverage reporting (pytest-cov)
- [ ] Ensure all tests pass
- [ ] Achieve >80% code coverage

## Notes
- Use pytest for all tests
- Use pytest-asyncio for async tests
- Use pytest-mock or unittest.mock for mocking
- Mock Telegram API: simulate message sending, receiving, reactions
- Test fixtures:
  - database session
  - test users (admin, friend, regular)
  - test messages
  - test memories
- E2E test pattern:
  1. Setup test data
  2. Simulate Telegram message
  3. Verify bot response
  4. Check database state
- CI/CD: run tests on every push/PR
- Code coverage: use pytest-cov, report to codecov.io

## Agent Comments
<!-- Add progress notes here as you work on this PRP -->
