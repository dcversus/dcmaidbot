# PRP-011: Canary Deployment & Sister Bot Communication

## Description
Create dcmaidbot-canary - a happy little sister bot for E2E production testing, canary releases (5%), status page updates, and inter-bot communication API for summary sharing and agent tool collaboration.

## Requirements

### Canary Bot Setup
- Create separate Telegram bot (@dcmaidbot_canary)
- Deploy as canary deployment in Kubernetes (5% traffic/users)
- Share database with main bot for testing
- Separate config: CANARY_BOT_TOKEN in .env
- Runs same codebase with canary flag

### E2E Production Testing
- Automated cron tests via canary bot
- Test all major flows: jokes, memories, favors, RAG
- Post results to status page
- Alert on failures
- Run every hour in production

### Status Page Integration
- Create status page endpoint (HTTP server in bot)
- Update status after each test cycle
- Show: uptime, last test results, active features
- Public endpoint: /health, /status
- Integration with external status services

### Canary Release Strategy
- 5% of test users routed to canary
- Gradual rollout on version updates
- Automatic rollback on failures
- Metrics comparison (canary vs stable)
- A/B testing capabilities

### Inter-Bot Communication API
- REST/gRPC API for bot-to-bot communication
- Share conversation summaries
- Synchronize memories between bots
- Agent tool sharing (web search, games)
- Collaborative responses
- Message forwarding between bots

### Summary Sharing
- Canary bot sends test summaries to main bot
- Main bot learns from canary experiments
- Shared RAG knowledge base
- Synchronized joke learning
- Cross-bot analytics

## Definition of Ready (DOR)
- [x] All PRPs 001-010 completed
- [ ] Main dcmaidbot deployed and stable
- [ ] Canary Telegram bot token obtained
- [ ] Canary deployment strategy designed
- [ ] Status page design planned
- [ ] Inter-bot API protocol defined

## Definition of Done (DOD)
- [ ] Canary bot configuration in .env (CANARY_BOT_TOKEN, CANARY_MODE)
- [ ] Canary deployment manifest created (k8s/canary-deployment.yaml)
- [ ] Canary routing logic implemented (5% users)
- [ ] E2E test suite for production (tests/e2e/production/)
- [ ] Cron job for automated testing created
- [ ] Status page HTTP server implemented (services/status_server.py)
- [ ] /health and /status endpoints working
- [ ] Inter-bot communication API created (services/bot_api.py)
- [ ] Summary sharing between bots working
- [ ] Agent tool sharing implemented
- [ ] Canary rollback mechanism working
- [ ] Status page updates on test completion
- [ ] Unit tests for canary logic
- [ ] Unit tests for inter-bot API
- [ ] Unit tests for status page
- [ ] E2E test for canary deployment flow
- [ ] Documentation for canary setup

## Progress

### Canary Bot Setup
- [ ] Obtain @dcmaidbot_canary Telegram bot token
- [ ] Add CANARY_BOT_TOKEN to .env.example
- [ ] Add CANARY_MODE flag to configuration
- [ ] Create canary deployment manifest (k8s/canary-deployment.yaml)
- [ ] Implement canary routing (5% logic in middleware)

### E2E Production Testing
- [ ] Create tests/e2e/production/ directory
- [ ] Implement test_jokes_production.py
- [ ] Implement test_memories_production.py
- [ ] Implement test_favors_production.py
- [ ] Implement test_rag_production.py
- [ ] Create services/production_tester.py
- [ ] Add cron job for hourly testing
- [ ] Alert mechanism on test failures

### Status Page
- [ ] Create services/status_server.py (HTTP server)
- [ ] Implement /health endpoint (liveness check)
- [ ] Implement /status endpoint (test results, uptime)
- [ ] Implement /metrics endpoint (Prometheus format)
- [ ] Add status page update logic after tests
- [ ] Configure port (default: 8080)

### Canary Deployment
- [ ] Create k8s/canary-deployment.yaml
- [ ] Implement 5% user routing logic
- [ ] Add canary metrics collection
- [ ] Implement automatic rollback on failures
- [ ] Create canary monitoring dashboard

### Inter-Bot Communication API
- [ ] Design API protocol (REST or gRPC)
- [ ] Create services/bot_api.py (API server)
- [ ] Implement /api/summary endpoint (share summaries)
- [ ] Implement /api/memories endpoint (sync memories)
- [ ] Implement /api/tools endpoint (share agent tools)
- [ ] Implement /api/message endpoint (forward messages)
- [ ] Add authentication between bots (shared secret)
- [ ] Create API client in services/bot_api_client.py

### Summary Sharing
- [ ] Implement summary export from canary to main
- [ ] Implement summary import in main bot
- [ ] Sync RAG knowledge base between bots
- [ ] Sync joke learning between bots
- [ ] Cross-bot analytics aggregation

### Testing
- [ ] Write unit tests for canary routing
- [ ] Write unit tests for production tests
- [ ] Write unit tests for status server
- [ ] Write unit tests for inter-bot API
- [ ] Write E2E test for canary deployment
- [ ] Write E2E test for bot-to-bot communication

## Notes

### Canary Deployment Architecture
```
Users
  ↓
Telegram API
  ↓
  ├─ 95% → dcmaidbot (stable)
  └─ 5%  → dcmaidbot-canary (testing)
       ↓
    E2E Tests → Status Page
       ↓
    API → Share to Main Bot
```

### Inter-Bot API Endpoints

**Server (both bots expose):**
- `POST /api/summary` - Receive conversation summary
- `POST /api/memories` - Sync memories
- `GET /api/tools` - List available agent tools
- `POST /api/message` - Forward message between bots
- `GET /api/status` - Get bot status

**Authentication:**
- Shared secret in .env: `BOT_API_SECRET`
- JWT tokens for requests
- Rate limiting

### Canary Routing Logic

```python
def route_to_canary(user_id: int) -> bool:
    """Determine if user should use canary bot (5%)."""
    # Use user_id hash for consistent routing
    return (hash(user_id) % 100) < 5
```

### Status Page Example

```json
{
  "status": "healthy",
  "version": "0.1.0",
  "uptime_seconds": 3600,
  "last_test": {
    "timestamp": "2025-10-26T14:00:00Z",
    "results": {
      "jokes": "pass",
      "memories": "pass",
      "favors": "pass",
      "rag": "pass"
    }
  },
  "features": ["waifu", "jokes", "memories", "rag", "favors"]
}
```

### Environment Variables

```env
# Canary configuration
CANARY_MODE=false  # Set to true for canary bot
CANARY_BOT_TOKEN=your_canary_bot_token
BOT_API_SECRET=shared_secret_between_bots
BOT_API_PORT=8080

# Main bot API endpoint (for canary to call)
MAIN_BOT_API_URL=http://dcmaidbot:8080

# Canary bot API endpoint (for main to call)
CANARY_BOT_API_URL=http://dcmaidbot-canary:8080
```

### Kubernetes Manifests

**Service for API:**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: dcmaidbot
  namespace: dcmaidbot
spec:
  selector:
    app: dcmaidbot
  ports:
  - name: api
    port: 8080
    targetPort: 8080
  - name: metrics
    port: 9090
    targetPort: 9090
```

**Canary Deployment:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dcmaidbot-canary
  namespace: dcmaidbot
  labels:
    app: dcmaidbot
    version: canary
spec:
  replicas: 1  # Small for canary
  selector:
    matchLabels:
      app: dcmaidbot
      version: canary
  template:
    metadata:
      labels:
        app: dcmaidbot
        version: canary
    spec:
      containers:
      - name: dcmaidbot
        image: ghcr.io/dcversus/dcmaidbot:canary
        env:
        - name: CANARY_MODE
          value: "true"
        # ... same secrets as main
```

### Production Test Suite Example

```python
# tests/e2e/production/test_jokes_production.py
async def test_joke_generation_production():
    """Test joke generation in production canary bot."""
    # Send message to canary bot
    # Wait for joke response
    # Check joke quality
    # Log results to status page
    pass
```

### Implementation Phases

**Phase 1: Basic Canary (Week 1)**
- Setup canary bot token
- Create canary deployment
- Basic status page

**Phase 2: E2E Testing (Week 2)**
- Production test suite
- Cron job automation
- Status page updates

**Phase 3: Inter-Bot API (Week 3)**
- API server implementation
- Summary sharing
- Memory synchronization

**Phase 4: Advanced (Week 4)**
- Agent tool sharing
- Collaborative responses
- A/B testing metrics

## Dependencies

- PRP-003: PostgreSQL (shared database)
- PRP-004: Memories (sync between bots)
- PRP-006: Jokes (learning sync)
- PRP-007: RAG (shared knowledge)
- PRP-008: Cron (automated testing)
- PRP-009: Tools (tool sharing API)

## Benefits

1. **Safety**: Test in production with minimal risk
2. **Confidence**: Automated E2E tests before full rollout
3. **Monitoring**: Real-time status page
4. **Collaboration**: Bots learn from each other
5. **Scalability**: Multiple bot instances sharing knowledge

## Agent Comments
<!-- Add progress notes here as you work on this PRP -->
