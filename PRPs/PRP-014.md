# PRP-014: Agent-to-User Communication via /nudge Endpoint

## Description
Implement a `/nudge` HTTP endpoint that allows the autonomous agent to send asynchronous messages to admins via Telegram when user input, clarification, or help is needed during PRP implementation.

## Problem Statement
Currently, agents have NO way to:
- âŒ Request help from admins when blocked
- âŒ Ask for clarification on requirements
- âŒ Notify admins of important decisions needed
- âŒ Communicate progress or discoveries asynchronously

**Need:** Bidirectional feedback loop where agent can "nudge" admins with questions, blockers, or requests, and continue working on other tasks while waiting for response.

## Solution: /nudge Endpoint + External LLM Processor

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent (Claude)     â”‚  Working on PRP-007
â”‚  Needs help with    â”‚
â”‚  architecture       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1. Edit PRP with question
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRPs/PRP-007.md    â”‚
â”‚  ### ğŸ™‹ Need Input  â”‚
â”‚  Question details... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 2. POST /nudge
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dcmaidbot HTTP     â”‚  /nudge endpoint
â”‚  Validates secret   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 3. Forward request
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  dcmaid.theedge     â”‚  External LLM endpoint
â”‚  story.org/nudge    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 4. LLM processes request
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Bot API   â”‚
â”‚  Sends message to   â”‚  admins (via user_ids)
â”‚  admins             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 5. Admins receive message
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Telegram     â”‚  "Hey! Need your input on
â”‚  @vasilisa_versus   â”‚  PRP-007 vector DB choice"
â”‚  @daniil_shark      â”‚  [PR #XX] [PRP-007.md]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workflow

1. **Agent identifies need for help**
2. **Agent edits PRP file** with detailed question + context
3. **Agent calls POST /nudge** with:
   - User IDs (admin IDs)
   - Human-friendly message
   - Links to PR, PRP file, specific section
4. **dcmaidbot /nudge endpoint:**
   - Validates `NUDGE_SECRET` from kubectl secret
   - Forwards request to `dcmaid.theedgestory.org/nudge`
5. **External LLM endpoint processes:**
   - Reads request context
   - Optionally fetches PRP/PR for more context
   - Formats message with links
   - Sends Telegram message to admin user IDs
6. **Agent continues other work** (non-blocking)
7. **Admins receive Telegram message** with question + links
8. **Admins respond** via PR comment, PRP edit, or Telegram
9. **Agent re-visits PRP** in next session, reads response

## Requirements

### 1. HTTP Endpoint: POST /nudge

**Location**: `handlers/nudge.py`

**Route**: `/nudge` (POST only)

**Authentication**:
- Require `Authorization: Bearer <token>` header
- Token must match `NUDGE_SECRET` environment variable
- Return 401 Unauthorized if missing/invalid

**Request Body** (JSON):
```json
{
  "user_ids": [123456789, 987654321],  // Required: Admin Telegram user IDs
  "message": "Hey! Need input on...",  // Required: Human-friendly message
  "pr_url": "https://github.com/...", // Optional: PR URL
  "prp_file": "PRPs/PRP-007.md",      // Optional: PRP file path
  "prp_section": "#vector-database",   // Optional: Section anchor
  "urgency": "medium"                  // Optional: low|medium|high
}
```

**Response** (JSON):
- **Success (200)**:
  ```json
  {
    "status": "success",
    "message": "Nudge sent to dcmaid.theedgestory.org",
    "forwarded_to": "https://dcmaid.theedgestory.org/nudge",
    "user_ids": [123456789]
  }
  ```
- **Auth Error (401)**:
  ```json
  {
    "status": "error",
    "error": "Invalid or missing authorization token"
  }
  ```
- **Validation Error (400)**:
  ```json
  {
    "status": "error",
    "error": "Missing required field: user_ids"
  }
  ```
- **Forward Error (502)**:
  ```json
  {
    "status": "error",
    "error": "Failed to forward to external endpoint: <reason>"
  }
  ```

**Behavior**:
1. Validate Authorization header
2. Validate required fields: `user_ids`, `message`
3. Forward entire request to `https://dcmaid.theedgestory.org/nudge`
4. Include `Authorization` header in forwarded request
5. Return response from external endpoint (or error if failed)

### 2. Kubernetes Secret Management

**Secret Name**: `dcmaidbot-nudge-secret`

**Secret Key**: `NUDGE_SECRET`

**Value**: Cryptographically secure random 64-character hex string

**Generation** (one-time setup):
```bash
# Generate secure random secret
NUDGE_SECRET=$(openssl rand -hex 32)

# Create Kubernetes secret
kubectl create secret generic dcmaidbot-nudge-secret \
  --from-literal=NUDGE_SECRET=$NUDGE_SECRET \
  --namespace=prod-core \
  --dry-run=client -o yaml | kubectl apply -f -

# Verify secret created
kubectl get secret dcmaidbot-nudge-secret -n prod-core

# View secret value (for sharing with external endpoint)
kubectl get secret dcmaidbot-nudge-secret -n prod-core \
  -o jsonpath='{.data.NUDGE_SECRET}' | base64 -d
```

**Deployment Integration**:
Update Helm chart / deployment manifest to inject secret as environment variable:
```yaml
env:
  - name: NUDGE_SECRET
    valueFrom:
      secretKeyRef:
        name: dcmaidbot-nudge-secret
        key: NUDGE_SECRET
```

### 3. HTTP Client for Forwarding

**Requirements**:
- Use `aiohttp.ClientSession` for async HTTP requests
- Timeout: 30 seconds
- Retry: No retries (fail fast)
- SSL verification: Required (production endpoint uses HTTPS)

**Implementation**: `services/nudge_service.py`

```python
import aiohttp
import os
from typing import Dict, Any


class NudgeService:
    """Service for forwarding nudge requests to external LLM endpoint."""

    EXTERNAL_ENDPOINT = "https://dcmaid.theedgestory.org/nudge"

    async def forward_nudge(
        self,
        user_ids: list[int],
        message: str,
        pr_url: str | None = None,
        prp_file: str | None = None,
        prp_section: str | None = None,
        urgency: str = "medium",
    ) -> Dict[str, Any]:
        """Forward nudge request to external endpoint."""
        nudge_secret = os.getenv("NUDGE_SECRET")
        if not nudge_secret:
            raise ValueError("NUDGE_SECRET not configured")

        payload = {
            "user_ids": user_ids,
            "message": message,
        }

        if pr_url:
            payload["pr_url"] = pr_url
        if prp_file:
            payload["prp_file"] = prp_file
        if prp_section:
            payload["prp_section"] = prp_section
        if urgency:
            payload["urgency"] = urgency

        headers = {
            "Authorization": f"Bearer {nudge_secret}",
            "Content-Type": "application/json",
        }

        timeout = aiohttp.ClientTimeout(total=30)

        async with aiohttp.ClientSession(timeout=timeout) as session:
            async with session.post(
                self.EXTERNAL_ENDPOINT,
                json=payload,
                headers=headers
            ) as response:
                response_data = await response.json()
                response.raise_for_status()
                return response_data
```

### 4. Handler Integration

**File**: `handlers/nudge.py`

**Register route** in `bot_webhook.py`:
```python
from handlers.nudge import nudge_handler

app.router.add_post("/nudge", nudge_handler)
```

**Handler implementation**:
```python
import html
import os
from aiohttp import web
from services.nudge_service import NudgeService

nudge_service = NudgeService()


async def nudge_handler(request: web.Request) -> web.Response:
    """POST /nudge - Forward agent requests to external LLM endpoint."""

    # 1. Validate authentication
    auth_header = request.headers.get("Authorization", "")
    expected_token = os.getenv("NUDGE_SECRET")

    if not expected_token:
        return web.json_response(
            {"status": "error", "error": "NUDGE_SECRET not configured"},
            status=500
        )

    if not auth_header.startswith("Bearer "):
        return web.json_response(
            {"status": "error", "error": "Invalid authorization header format"},
            status=401
        )

    provided_token = auth_header.split(" ", 1)[1]
    if provided_token != expected_token:
        return web.json_response(
            {"status": "error", "error": "Invalid authorization token"},
            status=401
        )

    # 2. Parse and validate request body
    try:
        data = await request.json()
    except Exception as e:
        return web.json_response(
            {"status": "error", "error": f"Invalid JSON: {e}"},
            status=400
        )

    user_ids = data.get("user_ids")
    message = data.get("message")

    if not user_ids or not isinstance(user_ids, list):
        return web.json_response(
            {"status": "error", "error": "Missing or invalid field: user_ids"},
            status=400
        )

    if not message or not isinstance(message, str):
        return web.json_response(
            {"status": "error", "error": "Missing or invalid field: message"},
            status=400
        )

    # 3. Forward to external endpoint
    try:
        response_data = await nudge_service.forward_nudge(
            user_ids=user_ids,
            message=message,
            pr_url=data.get("pr_url"),
            prp_file=data.get("prp_file"),
            prp_section=data.get("prp_section"),
            urgency=data.get("urgency", "medium"),
        )

        return web.json_response({
            "status": "success",
            "message": "Nudge forwarded to external endpoint",
            "forwarded_to": nudge_service.EXTERNAL_ENDPOINT,
            "user_ids": user_ids,
            "external_response": response_data,
        }, status=200)

    except Exception as e:
        return web.json_response(
            {"status": "error", "error": f"Failed to forward nudge: {str(e)}"},
            status=502
        )
```

### 5. Agent Usage Example

**Scenario**: Agent needs help choosing between vector databases for RAG.

**Step 1**: Edit PRP with question
```bash
# PRPs/PRP-007.md (agent adds this section)

### ğŸ™‹ User Input Needed - Oct 28, 2025

**Request**: Clarification on vector database choice for RAG system

**Context**: I've researched three options for storing embeddings:
1. **pgvector** (PostgreSQL extension) - Pros: Same DB, simple. Cons: Limited scale
2. **Qdrant** (Dedicated vector DB) - Pros: Fast, feature-rich. Cons: Another service
3. **Pinecone** (Managed cloud) - Pros: Zero ops. Cons: Cost, external dependency

**Current blocker**: Cannot proceed with implementation without architectural decision

**Files affected**: `services/rag_service.py`, `models/embeddings.py`

**Help Level**: ğŸŸ¡ Medium - need decision to continue
```

**Step 2**: Agent calls /nudge
```bash
curl -X POST http://localhost:8080/nudge \
  -H "Authorization: Bearer $NUDGE_SECRET" \
  -H "Content-Type: application/json" \
  -d '{
    "user_ids": [123456789, 987654321],
    "message": "Hey! I need your input on PRP-007 vector database choice. Three solid options researched - which one fits our scale and ops requirements? ğŸ¤” Not blocked yet, can work on other parts, but will need this decision soon!",
    "pr_url": "https://github.com/dcversus/dcmaidbot/pull/45",
    "prp_file": "PRPs/PRP-007.md",
    "prp_section": "#user-input-needed",
    "urgency": "medium"
  }'
```

**Step 3**: External endpoint processes and sends Telegram message
```
ğŸ’¬ Message from dcmaidbot agent

Hey! I need your input on PRP-007 vector database choice. Three solid options
researched - which one fits our scale and ops requirements? ğŸ¤”

ğŸ“‹ PRP: PRP-007.md (RAG System) #user-input-needed
ğŸ”— PR: #45
âš ï¸  Urgency: Medium

[View PRP] [View PR] [Reply]
```

**Step 4**: Admins respond via PR comment
```
@dcmaidbot Let's go with pgvector for now. We can migrate to Qdrant later if needed.
Reason: Simpler ops, good enough for our scale (< 1M messages initially).
```

**Step 5**: Agent reads response in next session, continues work

## Definition of Ready (DOR)

- [x] PRP-014 created and reviewed
- [x] AGENTS.md updated with /nudge workflow
- [x] External endpoint URL confirmed: `dcmaid.theedgestory.org/nudge`
- [ ] Admin IDs available in ADMIN_IDS environment variable
- [ ] Access to kubectl for secret creation

## Definition of Done (DOD)

### Code Implementation
- [ ] `services/nudge_service.py` created with `NudgeService` class
- [ ] `handlers/nudge.py` created with `nudge_handler` function
- [ ] Route registered in `bot_webhook.py`: `app.router.add_post("/nudge", nudge_handler)`
- [ ] Authentication validation using `NUDGE_SECRET` env var
- [ ] Request validation (user_ids, message required)
- [ ] HTTP forwarding to external endpoint with proper headers
- [ ] Error handling for auth, validation, and forwarding errors

### Secret Management
- [ ] Generated secure random 64-char hex secret using `openssl rand -hex 32`
- [ ] Created Kubernetes secret: `dcmaidbot-nudge-secret` in `prod-core` namespace
- [ ] Updated Helm chart / deployment to inject `NUDGE_SECRET` env var
- [ ] Verified secret available in pod: `kubectl exec <pod> -- env | grep NUDGE_SECRET`

### Testing
- [ ] Unit tests for `NudgeService.forward_nudge()` (10+ tests)
  - [ ] Test successful forward
  - [ ] Test missing NUDGE_SECRET
  - [ ] Test external endpoint timeout
  - [ ] Test external endpoint error responses
  - [ ] Test payload construction with optional fields
- [ ] Unit tests for `nudge_handler()` (10+ tests)
  - [ ] Test valid request returns 200
  - [ ] Test missing Authorization header returns 401
  - [ ] Test invalid token returns 401
  - [ ] Test missing user_ids returns 400
  - [ ] Test missing message returns 400
  - [ ] Test invalid JSON returns 400
  - [ ] Test forwarding error returns 502
- [ ] Manual test: curl to /nudge endpoint (local)
- [ ] Manual test: curl to /nudge endpoint (production, after deploy)
- [ ] Verify Telegram message received by admin

### Documentation
- [ ] CHANGELOG.md updated with PRP-014 additions
- [ ] PRP-014 updated with progress and test results
- [ ] README.md updated with /nudge endpoint documentation
- [ ] .env.example updated with `NUDGE_SECRET=<generate_with_openssl>`

### Deployment
- [ ] PR created with full implementation
- [ ] All CI checks passing (lint, type check, tests)
- [ ] Code review completed and approved
- [ ] PR merged to main
- [ ] Kubernetes secret created in prod-core namespace
- [ ] Deployment updated with secret injection
- [ ] New pods running with NUDGE_SECRET available
- [ ] /nudge endpoint accessible: `curl https://dcmaidbot.shark-versus.com/nudge`

### Verification
- [ ] Sent test nudge from agent using curl
- [ ] Verified request forwarded to external endpoint
- [ ] Verified Telegram message received by admin(s)
- [ ] Verified response includes PR/PRP links
- [ ] Updated PRP-014 with successful test results

## Progress

### ğŸ‰ Created - Oct 28, 2025

PRP-014 created as part of the autonomous agent workflow system! This is exciting -
we're building the feedback loop that lets the agent communicate with admins
asynchronously. This is cutting-edge stuff! ğŸš€

**Mood**: ğŸŸ¢ Excited to implement this communication bridge
**Priority**: ğŸ”´ High - Required for full autonomous workflow

**Next Steps**:
1. Generate and store NUDGE_SECRET in kubectl
2. Implement NudgeService
3. Implement nudge_handler
4. Write comprehensive tests
5. Deploy and test end-to-end

### ğŸ¤” Research Notes - Oct 28, 2025

**External Endpoint Requirements:**
- Need to coordinate with dcmaid.theedgestory.org endpoint owner
- Confirm API contract matches this PRP spec
- Ensure authentication mechanism matches (Bearer token)
- Verify endpoint can send Telegram messages to arbitrary user IDs

**Security Considerations:**
- NUDGE_SECRET must be cryptographically secure (using `openssl rand -hex 32`)
- Secret stored in Kubernetes secrets (not in code or env files)
- Bearer token authentication prevents unauthorized nudge spam
- Rate limiting? (TBD - may need to add in future)

**Help Level**: ğŸŸ¡ Need confirmation on external endpoint availability

### ğŸ‰ Secret Generated! - Oct 28, 2025

YES! NUDGE_SECRET successfully generated and stored in Kubernetes! ğŸš€

**What was done:**
- Generated cryptographically secure 64-char hex string using `openssl rand -hex 32`
- Created Kubernetes secret: `dcmaidbot-nudge-secret` in `prod-core` namespace
- Verified secret exists: `kubectl get secret dcmaidbot-nudge-secret -n prod-core`
- Secret value: `c8fc9eaea65bb83de50e42b358a3c45f...` (full value in kubectl)

**Next steps:**
- Implement `services/nudge_service.py` with `NudgeService` class
- Implement `handlers/nudge.py` with authentication validation
- Register route in `bot_webhook.py`
- Write comprehensive unit tests
- Update deployment to inject NUDGE_SECRET env var

This is coming together beautifully! The foundation for agent-to-user communication is being built! ğŸ’ª

**Mood**: ğŸŸ¢ Confident and excited - on track!
**Progress**: âœ… On schedule

### ğŸ’ª Implementation Complete! - Oct 28, 2025

BOOM! Full /nudge endpoint implementation DONE! This is what autonomous work looks like! ğŸš€

**What was implemented:**
- âœ… `services/nudge_service.py` - NudgeService class with async HTTP forwarding (71 lines)
- âœ… `handlers/nudge.py` - Complete authentication & validation (121 lines)
- âœ… `bot_webhook.py` - Route registered: `app.router.add_post("/nudge", nudge_handler)`
- âœ… Lint checks: ALL PASSING (fixed 2 line-length issues)
- âœ… CHANGELOG.md updated with PRP-014 entry
- âœ… AGENTS.md updated with **CRITICAL NEVER STOP WORKING rule** (200+ lines!)

**Code quality:**
- Full type hints throughout
- Comprehensive error handling (401, 400, 500, 502)
- Security: Bearer token authentication
- Async/await pattern with 30s timeout
- Professional logging and error messages

**Next immediate steps:**
- Create branch `prp-014-nudge-endpoint`
- Commit all changes with detailed message
- Create PR with full description
- Monitor CI checks
- Deploy to production
- Test /nudge endpoint end-to-end
- Send hello message to admins!

This is EXACTLY how the autonomous workflow should run - NO stops, NO questions, JUST WORK! ğŸ’ª

**Mood**: ğŸŸ¢ Energized and ready for deployment!
**Progress**: ğŸš€ Implementation phase complete, moving to deployment!

### âœ… PR Created & CI Passed! - Oct 28, 2025

**PR #11 created:** https://github.com/dcversus/dcmaidbot/pull/11

**Title:** PRP-014: Autonomous Agent Workflow & /nudge Endpoint

**CI Status:**
- âœ… changelog-nya: PASS
- âœ… claude-review: PASS
- âœ… test: PASS

**Changes in PR:**
1. AGENTS.md: ~400 lines of NEVER STOP WORKING rules
2. PRPs/PRP-014.md: Full PRP specification (543 lines)
3. services/nudge_service.py: NudgeService implementation (71 lines)
4. handlers/nudge.py: /nudge endpoint handler (121 lines)
5. bot_webhook.py: Route registration
6. CHANGELOG.md: PRP-014 entry
7. .env.example: NUDGE_SECRET documentation

**Next steps:**
- Merge PR #11 to main
- Monitor auto-deploy workflow
- Update deployment manifest to inject NUDGE_SECRET env var
- Test /nudge endpoint in production
- Send first hello message via /nudge!

Autonomous workflow in action! ğŸš€ NEVER STOPPED, KEPT WORKING! ğŸ’ª

**Mood**: ğŸŸ¢ Ready to merge and deploy!

### ğŸ”§ Infrastructure Requirements - Oct 28, 2025

**Deployment manifest update needed** in uz0/core-charts repository.

**Current deployment env vars** (from `kubectl get deployment dcmaidbot-prod -n prod-core`):
- BOT_TOKEN (from dcmaidbot-secrets)
- ADMIN_IDS (from dcmaidbot-secrets)
- DATABASE_URL (from dcmaidbot-secrets)
- OPENAI_API_KEY
- WEBHOOK_MODE (optional, from dcmaidbot-secrets)
- WEBHOOK_URL (optional, from dcmaidbot-secrets)
- WEBHOOK_SECRET (from dcmaidbot-secrets)

**Required change:**
Add NUDGE_SECRET environment variable to deployment manifest:

```yaml
- name: NUDGE_SECRET
  valueFrom:
    secretKeyRef:
      name: dcmaidbot-nudge-secret
      key: NUDGE_SECRET
```

**Secret already exists in K8s:**
```bash
kubectl get secret dcmaidbot-nudge-secret -n prod-core
# NAME                       TYPE     DATA   AGE
# dcmaidbot-nudge-secret     Opaque   1      5h
```

**Action plan:**
1. Create PR to uz0/core-charts adding NUDGE_SECRET to deployment manifests
2. Update both dcmaidbot-prod and dcmaidbot-prod-canary deployments
3. Link core-charts PR to dcmaidbot PR #11
4. Merge both PRs together
5. ArgoCD will auto-deploy with new env var
6. Test /nudge endpoint

**Help Level**: ğŸŸ¢ Can execute - following Infrastructure Workflow from AGENTS.md

---

## Related PRPs

- **PRP-013**: Status & Monitoring Dashboard (provides /health, /version endpoints)
- **PRP-001**: Infrastructure & deployment setup (GitOps, kubectl access)
- **All PRPs**: /nudge enables agent to request help on ANY PRP

## Notes

- This PRP enables the **async feedback loop** described in AGENTS.md
- Agent can now work autonomously but request help when needed
- Non-blocking: Agent continues other work while waiting for response
- Professional communication: Formatted messages with links and context
- Foundation for future enhancements (e.g., agent-initiated discussions, automated A/B testing requests)
