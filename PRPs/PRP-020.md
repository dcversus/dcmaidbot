# PRP-020: Complete World Builder with Canvas Merging System

## Description
Implement a complete world builder system that generates all required files in `/static/` directory with proper canvas-based merging for widget states. The system must create individual canvas elements for each widget state, merge them with base backgrounds, and provide a Z-formation layout visible from top-down camera angle.

## Requirements

### 1. File Generation Structure
**Must create in `/static/`:**
- `result.json` - Main world configuration (not result_16bit.json)
- `tiles/` directory - Temporary tile files for debugging
- `scenes/` directory - All merged scene images

### 2. Required Scene Files (Complete Set)
For each widget with states (hover, click):
- `base-bg.jpg` - Base background image (black with grid)
- `widget-clock-hover-bg.jpg` - Clock hover state merged with base
- `widget-clock-click-bg.jpg` - Clock click state merged with base
- `widget-cactus-hover-bg.jpg` - Cactus hover state merged with base
- `widget-cactus-click-bg.jpg` - Cactus click state merged with base
- `widget-changelog-hover-bg.jpg` - Changelog hover state merged with base
- `widget-changelog-click-bg.jpg` - Changelog click state merged with base
- `widget-poster-hover-bg.jpg` - Poster hover state merged with base
- `widget-poster-click-bg.jpg` - Poster click state merged with base
- `widget-photo-hover-bg.jpg` - Photo hover state merged with base
- `widget-photo-click-bg.jpg` - Photo click state merged with base
- `widget-sketch-hover-bg.jpg` - Sketch hover state merged with base
- `widget-sketch-click-bg.jpg` - Sketch click state merged with base
- `widget-status-hover-bg.jpg` - Status hover state merged with base
- `widget-status-click-bg.jpg` - Status click state merged with base

**Total: 1 base + 14 widget states = 15 scene files**

### 3. Canvas Merging System
- **Single State + Single Widget**: Create individual canvas for each widget state
- **Absolute Coordinate Merging**: Merge widget canvas at exact coordinates to base canvas
- **Base Image Merge**: Always merge all canvases together for final scene
- **Letter/Image Blending**: Add visual indicators/labels to each widget state

### 4. Visual Layout Requirements
- **Background**: Black with visible grid lines
- **Widget Formation**: Z-formation layout visible from top-down camera angle
- **Mobile Responsive**: Center on mobile devices
- **Grid Visibility**: Clear grid lines for positioning reference

### 5. File Path Updates
- Update `index.html` to use `result.json` (not `result_16bit.json`)
- Update all scene file paths to use `/static/scenes/` directory
- Ensure proper 404 handling and file accessibility

## Definition of Ready (DOR)
- [x] PRP created with detailed requirements
- [x] Canvas merging algorithm designed
- [x] File structure requirements defined
- [x] Widget Z-formation layout planned

## Definition of Done (DoD)
- [ ] World builder script creates `/static/result.json`
- [ ] All 15 scene files generated in `/static/scenes/`
- [ ] Base background is black with visible grid
- [ ] Widgets positioned in Z-formation for top-down view
- [ ] Canvas merging system works for all widget states
- [ ] `index.html` updated to use correct file paths
- [ ] All files accessible via HTTP server (no 404 errors)
- [ ] Visual confirmation of proper widget positioning
- [ ] Mobile responsive layout confirmed
- [ ] E2E testÈ™åËØÅ all hover/click interactions work

## Implementation Plan

### Phase 1: World Builder Script
- Create `scripts/complete_world_builder.py`
- Generate black grid background as base
- Create individual widget canvases for each state
- Implement canvas merging with absolute coordinates
- Save all scenes to `/static/scenes/`

### Phase 2: Z-Formation Layout
- Define Z-formation coordinates for 7 widgets
- Ensure visibility from top-down camera angle
- Add mobile responsive positioning
- Create visual indicators/labels for widgets

### Phase 3: File Generation
- Generate `result.json` with correct paths
- Create all 15 scene files
- Update tile references and debug files
- Ensure proper file permissions

### Phase 4: Frontend Updates
- Update `index.html` JSON path to `result.json`
- Update scene paths to `/static/scenes/`
- Test all file accessibility
- Verify hover/click interactions

### Phase 5: Visual Testing
- Test desktop layout with Z-formation
- Test mobile responsive layout
- Verify grid visibility
- Confirm all state transitions work

## Technical Specifications

### Canvas Merging Algorithm
```python
def create_merged_scene(base_canvas, widget_canvas, x, y):
    """Merge widget canvas at absolute coordinates to base canvas"""
    merged = base_canvas.copy()
    merged.paste(widget_canvas, (x, y), widget_canvas)
    return merged
```

### Z-Formation Coordinates (1024x768 canvas)
- Widget 1: (200, 150) - Top left of Z
- Widget 2: (400, 250) - Middle top of Z
- Widget 3: (600, 350) - Middle right of Z
- Widget 4: (400, 450) - Middle bottom of Z
- Widget 5: (200, 550) - Bottom left of Z
- Widget 6: (800, 150) - Top right (bonus)
- Widget 7: (800, 550) - Bottom right (bonus)

### File Naming Convention
- Base: `/static/scenes/base-bg.jpg`
- Widget states: `/static/scenes/widget-{id}-{state}-bg.jpg`
- JSON: `/static/result.json`

## Progress Tracking

### ‚úÖ Completed
- [x] PRP created with requirements
- [x] Technical specifications defined

### üîÑ In Progress
- [ ] World builder script implementation
- [ ] Canvas merging system development

### ‚è≥ Pending
- [ ] Z-formation layout implementation
- [ ] File generation and path updates
- [ ] Frontend integration and testing

## Notes
- Priority: HIGH - Critical for interactive system functionality
- Dependencies: Canvas manipulation library (PIL/Pillow)
- Testing: Visual confirmation required for each widget state
- Performance: Scene generation should complete within 30 seconds
