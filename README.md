# ActivityBot - Telegram бот для выбора случайных активностей

Бот для создания пулов (категорий) активностей с механизмом справедливого случайного выбора с учётом пенальти.

## Возможности

- Создание и управление пулами (категориями) активностей
- Добавление активностей в пулы
- Система приглашений - только создатель пула может приглашать участников
- Случайный выбор активности с учётом справедливого распределения
- Система пенальти для равномерного использования активностей
- Работа только в личных сообщениях для защиты приватности

## Технические детали

Проект реализован на Python с использованием:
- aiogram 3.x - библиотека для Telegram Bot API
- pydantic - валидация данных
- pytest - тестирование с поддержкой asyncio

## Структура проекта

```
project-root/
├── bot.py                 # Основной файл запуска бота
├── handlers/
│   ├── categories.py      # Хендлеры управления пулами
│   ├── activities.py      # Хендлеры управления активностями
│   ├── selection.py       # Хендлеры выбора активностей
│   └── info.py            # Хендлеры получения информации
├── services/
│   ├── pool_service.py    # Бизнес-логика для управления пулами
│   ├── activity_service.py# Бизнес-логика для управления активностями
│   └── selection_service.py # Бизнес-логика выборов и пенальти
├── middlewares/
│   └── private_only.py    # Middleware для ограничения работы в ЛС
├── models/
│   └── data.py            # Описание структур данных
├── storage/
│   └── storage.json       # Хранилище данных JSON
├── tests/                 # Тесты проекта
│   ├── test_services.py   # Тесты сервисных функций
│   └── test_handlers.py   # Тесты хендлеров
├── conftest.py            # Конфигурация pytest
├── requirements.txt       # Python зависимости
└── .env                   # Переменные окружения
```

## Установка и запуск

### Локальный запуск

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd <repository-folder>
```

2. Создайте виртуальное окружение и активируйте его:
```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

4. Создайте файл .env с данными вашего бота:
```
BOT_TOKEN=your_bot_token_here
DEBUG=False
```

5. Запустите бота в режиме long polling:
```bash
python bot.py
```

### Деплой на Vercel

1. Создайте аккаунт на [Vercel](https://vercel.com) и установите [Vercel CLI](https://vercel.com/docs/cli):
```bash
npm i -g vercel
```

2. Авторизуйтесь в Vercel CLI:
```bash
vercel login
```

3. Задайте переменные окружения на Vercel (замените YOUR_BOT_TOKEN на ваш токен):
```bash
vercel env add BOT_TOKEN
```

4. Разверните проект на Vercel:
```bash
vercel
```

5. После успешного деплоя, установите вебхук для вашего бота:
```bash
python set_webhook.py https://your-vercel-project-url.vercel.app/api/webhook
```

## Команды бота

- `/start` - Начало работы с ботом
- `/help` - Показать справку
- `/create_pool` - Создать новый пул активностей
- `/join_pool [код]` - Присоединиться к существующему пулу по коду приглашения
- `/invite` - Пригласить участника в пул (только для создателя пула)
- `/exit_pool` - Выйти из пула
- `/my_pools` - Показать ваши пулы
- `/add_activity` - Добавить активность в пул
- `/list_activities` - Показать активности в пуле
- `/select [номер_пула]` - Выбрать случайную активность
- `/pool_info [название_пула]` - Показать информацию о пуле
- `/penalties` - Показать информацию о пенальти

## Система приглашений

В этом боте **только создатель пула** может приглашать новых участников. Система работает следующим образом:

1. Создатель пула использует команду `/invite`
2. Выбирает пул из списка своих пулов
3. Получает уникальный код приглашения
4. Отправляет этот код приглашаемому пользователю
5. Пользователь присоединяется с помощью `/join_pool код_приглашения`

## Система выбора активностей

Активности выбираются с учетом:
- Частоты предыдущих выборов (менее используемые имеют больший шанс)
- Времени последнего выбора (недавно выбранные имеют меньший шанс)
- Системы пенальти (участник получает штраф после выбора)

## Разработка и тестирование

Для запуска тестов используйте:
```bash
pytest tests/
```

При разработке используются:
- pytest-asyncio для асинхронного тестирования
- MemoryStorage для хранения состояний FSM
- JSON для постоянного хранения данных

## Лицензия

MIT 