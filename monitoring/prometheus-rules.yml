# Enhanced Status System Monitoring Rules

groups:
- name: dcmaidbot-status-system
  rules:
  # Enhanced Status Service Health
  - alert: StatusServiceDown
    expr: up{job="dcmaidbot"} == 0
    for: 1m
    labels:
      severity: critical
      service: status
    annotations:
      summary: "DCMAIDBot status service is down"
      description: "The DCMAIDBot status service has been down for more than 1 minute on {{ $labels.instance }}"

  # Version Thoughts Generation
  - alert: VersionThoughtsStale
    expr: time() - dcmaidbot_version_thoughts_timestamp > 7200  # 2 hours
    for: 5m
    labels:
      severity: warning
      service: status
    annotations:
      summary: "Version thoughts are stale"
      description: "Version thoughts have not been updated for more than 2 hours on {{ $labels.instance }}"

  # Self Check Thoughts Generation
  - alert: SelfCheckThoughtsStale
    expr: time() - dcmaidbot_self_check_thoughts_timestamp > 3600  # 1 hour
    for: 5m
    labels:
      severity: warning
      service: status
    annotations:
      summary: "Self-check thoughts are stale"
      description: "Self-check thoughts have not been updated for more than 1 hour on {{ $labels.instance }}"

  # Self Check Duration Alert
  - alert: SelfCheckDurationHigh
    expr: dcmaidbot_self_check_duration_seconds > 300  # 5 minutes
    for: 2m
    labels:
      severity: warning
      service: status
    annotations:
      summary: "Self-check duration is high"
      description: "Self-check is taking {{ $value }} seconds on {{ $labels.instance }}, which is above the 5-minute threshold"

  # Crypto Thoughts Generation
  - alert: CryptoThoughtsStale
    expr: time() - dcmaidbot_crypto_thoughts_timestamp > 86400  # 24 hours
    for: 10m
    labels:
      severity: warning
      service: crypto
    annotations:
      summary: "Crypto thoughts are stale"
      description: "Crypto thoughts have not been updated for more than 24 hours on {{ $labels.instance }}"

  # Crypto Thoughts Token Usage
  - alert: CryptoThoughtsTokenUsageHigh
    expr: dcmaidbot_crypto_thoughts_tokens > 5000  # High token usage
    for: 5m
    labels:
      severity: warning
      service: crypto
    annotations:
      summary: "High token usage in crypto thoughts"
      description: "Crypto thoughts generation used {{ $value }} tokens, which is unusually high"

  # Token Usage Monitoring
  - alert: TokenUsageRateHigh
    expr: rate(dcmaidbot_tokens_total[5m]) > 10  # tokens per second
    for: 5m
    labels:
      severity: warning
      service: llm
    annotations:
      summary: "High token usage rate"
      description: "Token usage rate is {{ $value }} tokens/second on {{ $labels.instance }}"

  # Database Connection Issues
  - alert: DatabaseConnectionFailed
    expr: dcmaidbot_database_connected == 0
    for: 1m
    labels:
      severity: critical
      service: database
    annotations:
      summary: "Database connection failed"
      description: "Cannot connect to PostgreSQL database on {{ $labels.instance }}"

  # Redis Connection Issues
  - alert: RedisConnectionFailed
    expr: dcmaidbot_redis_connected == 0
    for: 2m
    labels:
      severity: warning
      service: cache
    annotations:
      summary: "Redis connection failed"
      description: "Cannot connect to Redis cache on {{ $labels.instance }}"

  # LLM Service Response Time
  - alert: LLMResponseTimeHigh
    expr: dcmaidbot_llm_response_time_seconds > 30  # 30 seconds
    for: 5m
    labels:
      severity: warning
      service: llm
    annotations:
      summary: "LLM response time is high"
      description: "LLM service response time is {{ $value }} seconds on {{ $labels.instance }}"

  # LLM Service Error Rate
  - alert: LLMErrorRateHigh
    expr: rate(dcmaidbot_llm_errors_total[5m]) / rate(dcmaidbot_llm_requests_total[5m]) > 0.1  # 10% error rate
    for: 3m
    labels:
      severity: critical
      service: llm
    annotations:
      summary: "High LLM error rate"
      description: "LLM service error rate is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  # Memory Usage
  - alert: MemoryUsageHigh
    expr: dcmaidbot_memory_usage_bytes / dcmaidbot_memory_limit_bytes > 0.9  # 90%
    for: 5m
    labels:
      severity: warning
      service: system
    annotations:
      summary: "High memory usage"
      description: "Memory usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  # CPU Usage
  - alert: CPUUsageHigh
    expr: rate(dcmaidbot_cpu_seconds_total[5m]) > 0.8  # 80% CPU
    for: 5m
    labels:
      severity: warning
      service: system
    annotations:
      summary: "High CPU usage"
      description: "CPU usage is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

  # Bot Uptime
  - alert: BotUptimeLow
    expr: dcmaidbot_uptime_seconds < 300  # Less than 5 minutes
    for: 1m
    labels:
      severity: critical
      service: bot
    annotations:
      summary: "Bot uptime is low"
      description: "Bot has been running for only {{ $value }} seconds, possible restart loop"

  # Nudge System
  - alert: NudgeUnreadHigh
    expr: dcmaidbot_nudge_unread_count > 5
    for: 30m
    labels:
      severity: warning
      service: notifications
    annotations:
      summary: "High unread nudge count"
      description: "{{ $value }} unread nudge messages on {{ $labels.instance }}"

- name: dcmaidbot-business-metrics
  rules:
  # Business Test Pass Rate
  - alert: BusinessTestPassRateLow
    expr: dcmaidbot_business_test_pass_rate < 0.95  # 95% pass rate
    for: 10m
    labels:
      severity: warning
      service: testing
    annotations:
      summary: "Business test pass rate is low"
      description: "Business test pass rate is {{ $value | humanizePercentage }}, below 95% threshold"

  # LLM Judge Score
  - alert: LLMJudgeScoreLow
    expr: dcmaidbot_llm_judge_score < 0.8  # 80% score
    for: 5m
    labels:
      severity: warning
      service: quality
    annotations:
      summary: "LLM judge score is low"
      description: "LLM judge evaluation score is {{ $value }}, below 0.8 threshold"

  # Status Judge Validation
  - alert: StatusJudgeValidationFailed
    expr: dcmaidbot_status_judge_passed == 0
    for: 5m
    labels:
      severity: critical
      service: status
    annotations:
      summary: "Status judge validation failed"
      description: "Status judge validation is failing on {{ $labels.instance }}"

- name: dcmaidbot-security
  rules:
  # Failed Authentication Attempts
  - alert: FailedAuthHigh
    expr: rate(dcmaidbot_failed_auth_total[5m]) > 5  # 5 failed attempts per minute
    for: 2m
    labels:
      severity: warning
      service: security
    annotations:
      summary: "High failed authentication rate"
      description: "{{ $value }} failed authentication attempts per minute on {{ $labels.instance }}"

  # Suspicious Activity
  - alert: SuspiciousActivityDetected
    expr: rate(dcmaidbot_suspicious_requests_total[5m]) > 1  # 1 per minute
    for: 1m
    labels:
      severity: critical
      service: security
    annotations:
      summary: "Suspicious activity detected"
      description: "{{ $value }} suspicious requests per minute on {{ $labels.instance }}"
