# SLO/SLI Configuration for DCMAIDBot
# Service Level Objectives and Indicators monitoring configuration

apiVersion: v1
kind: ConfigMap
metadata:
  name: dcmaidbot-slo-config
  namespace: monitoring
  labels:
    app: dcmaidbot
    component: monitoring
data:
  slo-config.yaml: |
    # Service Level Indicators (SLIs)
    slis:
      availability:
        description: "Percentage of successful requests"
        query: "rate(http_requests_total{status!~'5..'}[5m]) / rate(http_requests_total[5m]) * 100"
        unit: "percentage"

      latency:
        description: "Request latency at 95th percentile"
        query: "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) * 1000"
        unit: "milliseconds"

      error_rate:
        description: "Percentage of requests resulting in errors"
        query: "rate(http_requests_total{status=~'5..'}[5m]) / rate(http_requests_total[5m]) * 100"
        unit: "percentage"

      throughput:
        description: "Requests per second"
        query: "rate(http_requests_total[5m])"
        unit: "requests_per_second"

      cpu_utilization:
        description: "CPU usage percentage"
        query: "rate(container_cpu_usage_seconds_total[5m]) * 100"
        unit: "percentage"

      memory_utilization:
        description: "Memory usage percentage"
        query: "container_memory_usage_bytes / container_spec_memory_limit_bytes * 100"
        unit: "percentage"

      bot_functionality:
        description: "Bot functionality success rate"
        query: "rate(bot_requests_successful_total[5m]) / rate(bot_requests_total[5m]) * 100"
        unit: "percentage"

    # Service Level Objectives (SLOs)
    slos:
      availability:
        name: "dcmaidbot-availability"
        description: "DCMAIDBot service availability"
        target: 99.9
        timeframe: "30d"
        sli: "availability"
        alerting:
          burn_rate_alerts:
            - name: "AvailabilityFastBurn"
              threshold: 14.4  # 5% of monthly error budget in 1 hour
              duration: "1h"
              severity: "critical"
            - name: "AvailabilitySlowBurn"
              threshold: 6.0   # 5% of monthly error budget in 6 hours
              duration: "6h"
              severity: "warning"

      latency:
        name: "dcmaidbot-latency"
        description: "DCMAIDBot request latency"
        target: 95  # 95th percentile below 1000ms
        target_value: 1000
        timeframe: "30d"
        sli: "latency"
        unit: "milliseconds"
        alerting:
          burn_rate_alerts:
            - name: "LatencyFastBurn"
              threshold: 20  # P95 > 1000ms for 20% of requests
              duration: "5m"
              severity: "critical"
            - name: "LatencySlowBurn"
              threshold: 10  # P95 > 1000ms for 10% of requests
              duration: "30m"
              severity: "warning"

      error_rate:
        name: "dcmaidbot-error-rate"
        description: "DCMAIDBot error rate"
        target: 1.0  # Maximum 1% error rate
        timeframe: "30d"
        sli: "error_rate"
        alerting:
          burn_rate_alerts:
            - name: "ErrorRateFastBurn"
              threshold: 5.0  # 5% error rate
              duration: "5m"
              severity: "critical"
            - name: "ErrorRateSlowBurn"
              threshold: 2.0  # 2% error rate
              duration: "30m"
              severity: "warning"

      functionality:
        name: "dcmaidbot-functionality"
        description: "DCMAIDBot functionality success rate"
        target: 99.0  # 99% of bot requests successful
        timeframe: "30d"
        sli: "bot_functionality"
        alerting:
          burn_rate_alerts:
            - name: "FunctionalityFastBurn"
              threshold: 95.0  # Below 95% success rate
              duration: "10m"
              severity: "critical"
            - name: "FunctionalitySlowBurn"
              threshold: 98.0  # Below 98% success rate
              duration: "1h"
              severity: "warning"

    # Error Budget Configuration
    error_budget:
      availability:
        monthly_budget: 43.2  # minutes (99.9% availability = 43.2 minutes downtime/month)
        alert_thresholds:
          - name: "ErrorBudgetExhausted"
            threshold: 100
            severity: "critical"
          - name: "ErrorBudgetWarning"
            threshold: 75
            severity: "warning"
          - name: "ErrorBudgetAlert"
            threshold: 50
            severity: "info"

    # Canary Deployment SLOs (stricter than production)
    canary_slos:
      availability:
        name: "dcmaidbot-canary-availability"
        description: "DCMAIDBot canary availability"
        target: 99.95  # Stricter target for canary
        timeframe: "1h"
        sli: "availability"

      latency:
        name: "dcmaidbot-canary-latency"
        description: "DCMAIDBot canary latency"
        target: 90  # 90th percentile below 500ms
        target_value: 500
        timeframe: "1h"
        sli: "latency"

      error_rate:
        name: "dcmaidbot-canary-error-rate"
        description: "DCMAIDBot canary error rate"
        target: 0.5  # Maximum 0.5% error rate for canary
        timeframe: "1h"
        sli: "error_rate"

    # Promotion Criteria (for canary to production promotion)
    promotion_criteria:
      minimum_canary_duration: "15m"
      success_rate_threshold: 99.5
      latency_p95_threshold: 800  # milliseconds
      error_rate_threshold: 0.8  # percentage
      sample_size_minimum: 1000  # minimum requests

    # Rollback Criteria
    rollback_criteria:
      immediate_rollback:
        - availability_drop_5min: "2%"  # 2% drop in 5 minutes
        - error_rate_spike: "5%"        # Error rate above 5%
        - latency_p99_increase: "200%"  # 99th percentile latency doubles

      gradual_rollback:
        - availability_drop_30min: "1%"  # 1% drop in 30 minutes
        - error_rate_increase: "2%"      # Error rate above 2%
        - user_complaints: 5             # 5 user complaints via /nudge

  prometheus-rules.yaml: |
    groups:
    - name: dcmaidbot-slo.rules
      rules:
      # Availability SLO
      - record: dcmaidbot:availability:rate5m
        expr: rate(http_requests_total{job="dcmaidbot",status!~"5.."}[5m]) / rate(http_requests_total{job="dcmaidbot"}[5m])

      - record: dcmaidbot:availability:burn_rate:1h
        expr: (1 - dcmaidbot:availability:rate5m) * 43200 / 3600

      - record: dcmaidbot:availability:burn_rate:6h
        expr: (1 - dcmaidbot:availability:rate5m) * 43200 / 21600

      # Latency SLO
      - record: dcmaidbot:latency:p95:rate5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="dcmaidbot"}[5m])) * 1000

      # Error Rate SLO
      - record: dcmaidbot:error_rate:rate5m
        expr: rate(http_requests_total{job="dcmaidbot",status=~"5.."}[5m]) / rate(http_requests_total{job="dcmaidbot"}[5m]) * 100

      # Functionality SLO
      - record: dcmaidbot:functionality:success_rate:rate5m
        expr: rate(bot_requests_successful_total{job="dcmaidbot"}[5m]) / rate(bot_requests_total{job="dcmaidbot"}[5m]) * 100

      # Canary-specific metrics
      - record: dcmaidbot:canary:availability:rate5m
        expr: rate(http_requests_total{job="dcmaidbot-canary",status!~"5.."}[5m]) / rate(http_requests_total{job="dcmaidbot-canary"}[5m])

      - record: dcmaidbot:canary:latency:p95:rate5m
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="dcmaidbot-canary"}[5m])) * 1000

    - name: dcmaidbot-slo.alerts
      rules:
      # Availability alerts
      - alert: AvailabilityFastBurn
        expr: dcmaidbot:availability:burn_rate:1h > 14.4
        for: 1m
        labels:
          severity: critical
          service: dcmaidbot
          slo: availability
        annotations:
          summary: "DCMAIDBot availability is burning error budget too fast"
          description: "Availability is consuming error budget at 14.4x the normal rate. Immediate action required."

      - alert: AvailabilitySlowBurn
        expr: dcmaidbot:availability:burn_rate:6h > 6.0
        for: 5m
        labels:
          severity: warning
          service: dcmaidbot
          slo: availability
        annotations:
          summary: "DCMAIDBot availability is consuming error budget faster than expected"
          description: "Availability is consuming error budget at 6x the normal rate. Investigation required."

      # Latency alerts
      - alert: LatencyHigh
        expr: dcmaidbot:latency:p95:rate5m > 1000
        for: 5m
        labels:
          severity: warning
          service: dcmaidbot
          slo: latency
        annotations:
          summary: "DCMAIDBot latency is above SLO threshold"
          description: "95th percentile latency is {{ $value }}ms, above the 1000ms SLO threshold."

      # Error rate alerts
      - alert: ErrorRateHigh
        expr: dcmaidbot:error_rate:rate5m > 1.0
        for: 2m
        labels:
          severity: critical
          service: dcmaidbot
          slo: error_rate
        annotations:
          summary: "DCMAIDBot error rate is above SLO threshold"
          description: "Error rate is {{ $value }}%, above the 1% SLO threshold."

      # Functionality alerts
      - alert: FunctionalityDegraded
        expr: dcmaidbot:functionality:success_rate:rate5m < 99.0
        for: 5m
        labels:
          severity: warning
          service: dcmaidbot
          slo: functionality
        annotations:
          summary: "DCMAIDBot functionality is degraded"
          description: "Bot functionality success rate is {{ $value }}%, below the 99% SLO threshold."

      # Canary alerts
      - alert: CanaryAvailabilityLow
        expr: dcmaidbot:canary:availability:rate5m < 99.95
        for: 2m
        labels:
          severity: critical
          service: dcmaidbot-canary
          slo: availability
        annotations:
          summary: "DCMAIDBot canary availability is below promotion threshold"
          description: "Canary availability is {{ $value }}%, below the 99.95% promotion threshold."

      - alert: CanaryLatencyHigh
        expr: dcmaidbot:canary:latency:p95:rate5m > 500
        for: 2m
        labels:
          severity: critical
          service: dcmaidbot-canary
          slo: latency
        annotations:
          summary: "DCMAIDBot canary latency is above promotion threshold"
          description: "Canary 95th percentile latency is {{ $value }}ms, above the 500ms promotion threshold."

  grafana-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "DCMAIDBot SLO Monitoring",
        "tags": ["dcmaidbot", "slo", "monitoring"],
        "timezone": "browser",
        "panels": [
          {
            "title": "Availability SLO",
            "type": "stat",
            "targets": [
              {
                "expr": "dcmaidbot:availability:rate5m * 100",
                "legendFormat": "Current Availability"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 99.5},
                    {"color": "yellow", "value": 99.8},
                    {"color": "green", "value": 99.9}
                  ]
                }
              }
            },
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "title": "Latency P95",
            "type": "graph",
            "targets": [
              {
                "expr": "dcmaidbot:latency:p95:rate5m",
                "legendFormat": "P95 Latency (ms)"
              }
            ],
            "yAxes": [
              {
                "label": "Latency (ms)",
                "max": 1000
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "title": "Error Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "dcmaidbot:error_rate:rate5m",
                "legendFormat": "Error Rate (%)"
              }
            ],
            "yAxes": [
              {
                "label": "Error Rate (%)",
                "max": 5
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "title": "Bot Functionality",
            "type": "graph",
            "targets": [
              {
                "expr": "dcmaidbot:functionality:success_rate:rate5m",
                "legendFormat": "Success Rate (%)"
              }
            ],
            "yAxes": [
              {
                "label": "Success Rate (%)",
                "min": 95
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          },
          {
            "title": "Canary vs Production",
            "type": "graph",
            "targets": [
              {
                "expr": "dcmaidbot:availability:rate5m * 100",
                "legendFormat": "Production Availability"
              },
              {
                "expr": "dcmaidbot:canary:availability:rate5m * 100",
                "legendFormat": "Canary Availability"
              }
            ],
            "yAxes": [
              {
                "label": "Availability (%)",
                "min": 99
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }
