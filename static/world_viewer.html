<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lilith's House - World Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Press Start 2P', monospace;
        }
        .container {
            position: relative;
            width: 1024px;
            height: 1024px;
        }
        .room {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .widget {
            position: absolute;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            font-size: 10px;
            border: 2px solid #ff69b4;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1a1a2e;
            color: #fff;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #ff69b4;
        }
        .modal-close {
            background: #ff69b4;
            border: none;
            color: #fff;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="info">
        <div>World: <span id="world-name">Loading...</span></div>
        <div>State: <span id="current-state">idle</span></div>
        <div>Widgets: <span id="widget-count">0</span></div>
    </div>

    <div class="container" id="room-container">
        <img id="room-image" class="room" alt="Room">
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div id="modal-body"></div>
            <button class="modal-close" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        let resultData = null;
        let currentState = 'idle';

        // Load result.json
        fetch('result.json')
            .then(r => r.json())
            .then(data => {
                resultData = data;
                initializeRoom();
            });

        function initializeRoom() {
            const location = resultData.locations[0];

            document.getElementById('world-name').textContent = location.name;
            document.getElementById('widget-count').textContent = location.widgets.length;

            // Set initial room image
            const roomImg = document.getElementById('room-image');
            roomImg.src = location.tiles.idle;

            // Create widget areas
            location.widgets.forEach(widget => {
                createWidget(widget, location.tiles);
            });

            // Global hover/click on room
            roomImg.addEventListener('mouseenter', () => {
                if (currentState === 'idle') {
                    roomImg.src = location.tiles.hover;
                    document.getElementById('current-state').textContent = 'hover';
                }
            });

            roomImg.addEventListener('mouseleave', () => {
                roomImg.src = location.tiles.idle;
                currentState = 'idle';
                document.getElementById('current-state').textContent = 'idle';
            });

            roomImg.addEventListener('click', () => {
                roomImg.src = location.tiles.click;
                document.getElementById('current-state').textContent = 'click';
                setTimeout(() => {
                    roomImg.src = location.tiles.idle;
                    currentState = 'idle';
                    document.getElementById('current-state').textContent = 'idle';
                }, 500);
            });
        }

        function createWidget(widget, roomTiles) {
            const area = document.createElement('div');
            area.className = 'widget';
            area.style.left = widget.position.x + 'px';
            area.style.top = widget.position.y + 'px';
            area.style.width = widget.size.width + 'px';
            area.style.height = widget.size.height + 'px';
            area.title = widget.name;

            // Widget-specific click handlers
            area.addEventListener('click', (e) => {
                e.stopPropagation();
                handleWidgetClick(widget);
            });

            document.getElementById('room-container').appendChild(area);
        }

        function handleWidgetClick(widget) {
            console.log(`Clicked: ${widget.name} (${widget.type})`);

            switch(widget.type) {
                case 'changelog':
                    openChangelog(widget.config.github_url);
                    break;
                case 'link':
                    window.open(widget.config.url, '_blank');
                    break;
                case 'story':
                    showModal(widget.config.markdown);
                    break;
                case 'easteregg':
                    showEasterEgg(widget.config.image, widget.config.caption);
                    break;
                case 'time':
                    alert(`Current time: ${new Date().toLocaleTimeString()}`);
                    break;
                default:
                    alert(`${widget.name} clicked!`);
            }
        }

        function openChangelog(url) {
            fetch(url)
                .then(r => r.text())
                .then(md => showModal(md));
        }

        function showModal(content) {
            document.getElementById('modal-body').innerHTML = content.replace(/\\n/g, '<br>');
            document.getElementById('modal').classList.add('show');
        }

        function showEasterEgg(imgPath, caption) {
            const html = `<img src="${imgPath}" style="max-width:100%"><p style="margin-top:20px">${caption}</p>`;
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
    </script>
</body>
</html>
